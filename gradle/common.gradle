/*
  Defines common gradle settings, properties and actions used by most builds.
 */



// bintray-related properties, common to all modules.
project.ext.bintrayRepoName = 'simplemes-core'
project.ext.bintrayUser = 'simplemes'

// Load the parent composite build's properties, as override for the main settings.
def compositePropFile = new File("../gradle.properties")
if (compositePropFile.exists()) {
  Properties props = new Properties()
  InputStream ins = new FileInputStream(compositePropFile)
  props.load(ins)
  ins.close()
  props.each {k,v ->
    logger.info("Using property '$k' to '$v' from $compositePropFile")
    try {
      project.setProperty(k,v)
    } catch (Exception ignored) {
      logger.info("Could not override property '$k' to '$v' from $compositePropFile")
    }
  }
}

println "in common setup, module = ${moduleName}, version = ${project.version}, micronaut = ${micronautBomVersion}"



assets {
  maxThreads = 4
  packagePlugin=false  // Can't use Grails plugin scheme here.
}

run.jvmArgs('-noverify', '-XX:TieredStopAtLevel=1')

groovydoc {
  destinationDir = new File("${project.docsDir}/html5/groovydoc")
}


// Module publishing task setup.
project.ext.pomConfig = {
  licenses {
    license {
      name "GNU GPL 3.0"
      url "http://www.webix.com/"
      distribution "repo"
    }
  }
  developers {
    developer {
      id "mphouston"
      name "Mike Houston"
      email "dev@simplemes.org"
    }
  }

  scm {
    url "https://github.com/simplemes/simplemes-core"
  }
}


task sourcesJar(type: Jar, dependsOn: classes) {
  classifier 'sources'
  from sourceSets.main.allSource
}

task javadocJar(type: Jar, dependsOn: javadoc) {
  classifier 'javadoc'
  from groovydoc.destinationDir
}

artifacts {
  archives sourcesJar
  archives javadocJar
}

publishing {
  publications {
    mavenPublication(MavenPublication) {
      from components.java
      artifact sourcesJar {
        classifier "sources"
      }
      artifact javadocJar {
        classifier "javadoc"
      }
      groupId 'org.simplemes'
      artifactId moduleName
      version project.version
      pom.withXml {
        def root = asNode()
        root.appendNode('description', moduleDescription)
        root.appendNode('name', moduleDescription)
        root.appendNode('url', 'https://github.com/simplemes/simplemes-core')
        root.children().last() + pomConfig
      }
    }
  }
}


// Bintray upload setup
// See https://github.com/bintray/gradle-bintray-plugin#Plugin_DSL for syntax.
bintray {
  user = bintrayUser
  key = System.getProperty('bintray_key')
  publications = ['mavenPublication']

  dryRun = false //[Default: false] Whether to run this as dry-run, without deploying
  publish = false //[Default: false] Whether version should be auto published after an upload
  override = false //[Default: false] Whether to override version artifacts already published

  pkg {
    repo = bintrayRepoName
    name = moduleName
    //userOrg = 'simplemes.org'
    licenses = ['GPL-3.0']
    vcsUrl = 'https://github.com/simplemes/simplemes-core.git'
    version {
      name = project.version
      desc = moduleDescription
      released  = new Date()
    }
  }

}


